generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  order_id            Int             @id @default(autoincrement())
  user_id             Int
  address_id          Int?
  cart_id             Int?
  total_amount        Decimal         @db.Decimal(10, 2)
  status              order_statuses? @default(pending)
  created_at          DateTime?       @default(now()) @db.Timestamp(6)
  shipped_at          DateTime?       @db.Timestamp(6)
  delivered_at        DateTime?       @db.Timestamp(6)
  applied_discount_id Int?
  address             address?        @relation(fields: [address_id], references: [address_id], onDelete: SetNull, onUpdate: NoAction)
  cart                cart?           @relation(fields: [cart_id], references: [cart_id], onDelete: SetNull, onUpdate: NoAction)
  User                User            @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  applied_discount    DiscountRule?   @relation(fields: [applied_discount_id], references: [discount_rule_id], onDelete: SetNull, onUpdate: NoAction)
  delivery            delivery?
  payment             payment[]
}

model User {
  user_id       Int        @id @default(autoincrement())
  first_name    String     @db.VarChar(50)
  last_name     String     @db.VarChar(50)
  email         String     @unique @db.VarChar(100)
  password_hash String     @db.VarChar(255)
  phone         String?    @db.VarChar(20)
  role          rols?      @default(customer)
  is_active     Boolean?   @default(true)
  created_at    DateTime?  @default(now()) @db.Timestamp(6)
  updated_at    DateTime?  @default(now()) @db.Timestamp(6)
  Order         Order[]
  address       address[]
  cart          cart[]
  review        review[]
  wishlist      wishlist[]
}

model address {
  address_id    Int          @id @default(autoincrement())
  user_id       Int
  street        String       @db.VarChar(100)
  postal_code   String       @db.VarChar(20)
  is_default    Boolean?     @default(false)
  Order         Order[]
  User          User         @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  postal_region PostalRegion @relation(fields: [postal_code], references: [postal_code], onDelete: Restrict, onUpdate: NoAction)
}

model PostalRegion {
  postal_code String    @id @db.VarChar(20)
  city        String    @db.VarChar(50)
  country     String    @db.VarChar(50)
  addresses   address[]
}

model cart {
  cart_id    Int        @id @default(autoincrement())
  user_id    Int
  created_at DateTime?  @default(now()) @db.Timestamp(6)
  is_active  Boolean?   @default(true)
  Order      Order[]
  User       User       @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  cartitem   cartitem[]
}

model cartitem {
  cart_item_id Int       @id @default(autoincrement())
  cart_id      Int
  product_id   Int
  quantity     Int
  added_at     DateTime? @default(now()) @db.Timestamp(6)
  cart         cart      @relation(fields: [cart_id], references: [cart_id], onDelete: Cascade, onUpdate: NoAction)
  product      product   @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)
}

model category {
  category_id    Int        @id @default(autoincrement())
  name           String     @db.VarChar(100)
  description    String?    @db.VarChar(255)
  parent_id      Int?
  category       category?  @relation("categoryTocategory", fields: [parent_id], references: [category_id], onUpdate: NoAction)
  other_category category[] @relation("categoryTocategory")
  product        product[]
}

model delivery {
  delivery_id     Int                @id @default(autoincrement())
  order_id        Int                @unique
  courier         String?            @db.VarChar(50)
  tracking_number String?            @db.VarChar(100)
  status          delivery_statuses? @default(preparing)
  updated_at      DateTime?          @default(now()) @db.Timestamp(6)
  Order           Order              @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
}

model payment {
  payment_id     Int               @id @default(autoincrement())
  order_id       Int
  method         methods
  amount         Decimal           @db.Decimal(10, 2)
  status         payment_statuses? @default(pending)
  transaction_id String?           @db.VarChar(100)
  created_at     DateTime?         @default(now()) @db.Timestamp(6)
  Order          Order             @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
}

model product {
  product_id       Int               @id @default(autoincrement())
  category_id      Int?
  name             String            @db.VarChar(100)
  description      String?           @db.VarChar(500)
  price            Decimal           @db.Decimal(10, 2)
  stock            Int?              @default(0)
  status           product_statuses? @default(active)
  image_url        String?           @db.VarChar(255)
  created_at       DateTime?         @default(now()) @db.Timestamp(6)
  updated_at       DateTime?         @default(now()) @db.Timestamp(6)
  discount_rule_id Int?
  cartitem         cartitem[]
  category         category?         @relation(fields: [category_id], references: [category_id], onUpdate: NoAction)
  discount_rule    DiscountRule?     @relation(fields: [discount_rule_id], references: [discount_rule_id], onDelete: SetNull, onUpdate: NoAction)
  review           review[]
  wishlist         wishlist[]
}

model review {
  review_id   Int       @id @default(autoincrement())
  user_id     Int
  product_id  Int
  rating      Int?
  comment     String?   @db.VarChar(500)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  is_approved Boolean?  @default(false)
  product     product   @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)
  User        User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
}

model wishlist {
  wishlist_id Int       @id @default(autoincrement())
  user_id     Int
  product_id  Int
  added_at    DateTime? @default(now()) @db.Timestamp(6)
  product     product   @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)
  User        User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, product_id])
}

enum delivery_statuses {
  preparing
  in_transit
  delivered
  returned
}

enum methods {
  card
  paypal
  cash_on_delivery
}

enum order_statuses {
  pending
  paid
  shipped
  delivered
  cancelled
}

enum payment_statuses {
  pending
  success
  failed
  refunded
}

enum product_statuses {
  active
  hidden
  out_of_stock
}

enum rols {
  customer
  admin
  manager
  support
}

enum types {
  percent
  fixed
}

enum discount_types {
  percent
  fixed
}

model DiscountRule {
  discount_rule_id Int            @id @default(autoincrement())
  code             String         @unique @db.VarChar(50)
  type             discount_types
  value            Decimal        @db.Decimal(10, 2)
  valid_from       DateTime
  valid_to         DateTime
  is_active        Boolean?       @default(true)
  products         product[]
  orders           Order[]
}
