# Coursework - E-commerce API

## Назва проєкту

**Coursework - E-commerce API**

Система управління електронною комерцією з REST API для інтернет-магазину.

## Опис проєкту та предметна область

Система управління електронною комерцією (e-commerce), що надає REST API для управління користувачами, продуктами, замовленнями, кошиками, оплатами, доставками та іншими сутностями інтернет-магазину.

Проєкт реалізує backend-систему для інтернет-магазину, що забезпечує повний цикл електронної комерції:

- **Управління користувачами**: реєстрація, автентифікація, профілі користувачів з різними ролями (клієнт, адміністратор, менеджер, підтримка)
- **Каталог продуктів**: управління товарами, категоріями, наявністю на складі, статусами продуктів
- **Кошик покупок**: додавання товарів, управління кількістю, активні та історичні кошики
- **Система замовлень**: створення замовлень, відстеження статусів (очікування, оплачено, відправлено, доставлено, скасовано), автоматичне управління складом
- **Оплата**: обробка платежів різними методами (карта, PayPal, готівка при отриманні), відстеження статусів платежів
- **Доставка**: управління доставками, відстеження посилок, статуси доставки
- **Відгуки та рейтинги**: система оцінок та коментарів до продуктів
- **Список бажань**: збереження товарів для майбутніх покупок
- **Система знижок**: правила знижок з обмеженням за часом та активністю
- **Адреси доставки**: управління адресами користувачів з прив'язкою до поштових регіонів

## Технологічний стек

- **Мова програмування**: JavaScript (Node.js версія 20)
- **ORM бібліотека**: Prisma 6.19.1
- **Фреймворк**: Fastify 5.6.2
- **База даних**: PostgreSQL
- **Фреймворк тестування**: Jest 29.7.0
- **Контейнеризація**: Docker, Docker Compose

## Встановлення та запуск

### Вимоги

- Node.js 20 або вище
- Docker та Docker Compose
- PostgreSQL (якщо запускаєте локально)

### Запуск через Docker

1. Клонуйте репозиторій:
```bash
git clone https://github.com/ValMai12/Labs_2.git
cd Coursework
```

2. Запустіть сервіси:
```bash
docker compose up -d
```

Ця команда запустить:
- PostgreSQL базу даних (порт 5434)
- PostgreSQL тестову базу даних (порт 5435)
- Додаток (порт 3000)

3. Застосуйте міграції бази даних:
```bash
docker compose exec app npx prisma migrate deploy
```

4. Додаток буде доступний за адресою: `http://localhost:3000`

### Локальний запуск для розробки

1. Клонуйте репозиторій:
```bash
git clone https://github.com/ValMai12/Labs_2.git
cd Coursework
```

2. Встановіть залежності:
```bash
npm install
```

3. Створіть файли `.env` та `.env.test` за наступною сігнатурою:
```env
# .env
DATABASE_URL="postgresql://postgres:password123@localhost:5432/coursework?schema=public"

# .env.test
DATABASE_URL="postgresql://postgres:password123@localhost:5432/coursework_test?schema=public"
```

4. Запустіть PostgreSQL локально

5. Застосуйте міграції:
```bash
npx prisma migrate deploy
npx prisma generate
```

6. Запустіть додаток:
```bash
npm run dev
```

Додаток буде доступний за адресою: `http://localhost:3000`

## Тестування

### Запуск всіх тестів

```bash
npm test
```

### Запуск тестів з покриттям коду

```bash
npm run test:coverage
```

### Запуск тестів у режимі спостереження

```bash
npm run test:watch
```

### Запуск конкретного тестового файлу

```bash
npm test -- test/integration/user.test.js
npm test -- test/unit/order.service.test.js
```

## Структура проєкту

```
coursework/
├── docker-compose.yml          # Docker конфігурація
├── Dockerfile                  # Конфігурація контейнера додатку
├── .dockerignore              # Файли, що ігноруються при Docker build
├── .gitignore                 # Ігнорування .env, node_modules, тощо
│
├── docs/                      # Додаткова документація
│   └── readme.md             # Основна документація (цей файл)
│
├── prisma/                    # Prisma схема та міграції
│   ├── schema.prisma          # Схема бази даних
│   └── migrations/            # Міграції бази даних
│       ├── 20251213154130_add_indexes/
│       └── addindexes.prisma
│
├── src/                       # Вихідний код
│   ├── db/
│   │   └── prisma.js          # Ініціалізація Prisma клієнта
│   │
│   ├── routes/                # API маршрути
│   │   ├── user.routes.js
│   │   ├── order.routes.js
│   │   ├── product.routes.js
│   │   ├── cart.routes.js
│   │   ├── cartitem.routes.js
│   │   ├── address.routes.js
│   │   ├── category.routes.js
│   │   ├── delivery.routes.js
│   │   ├── payment.routes.js
│   │   ├── wishlist.routes.js
│   │   ├── review.routes.js
│   │   ├── discountrule.routes.js
│   │   └── postalregion.routes.js
│   │
│   ├── schemas/               # JSON Schema для валідації запитів
│   │   ├── user.schemas.json
│   │   ├── order.schemas.json
│   │   ├── product.schemas.json
│   │   └── ...
│   │
│   ├── services/              # Бізнес-логіка
│   │   ├── user.service.js
│   │   ├── order.service.js
│   │   ├── product.service.js
│   │   └── ...
│   │
│   ├── utils/                 # Утиліти
│   │   └── errorHandler.js    # Обробка помилок
│   │
│   └── server.js              # Точка входу додатку
│
├── test/                      # Тестові файли
│   ├── helpers/
│   │   └── testDb.js          # Допоміжні функції для тестів
│   ├── integration/           # Інтеграційні тести
│   │   ├── user.test.js
│   │   ├── order.test.js
│   │   ├── product.test.js
│   │   └── ...
│   ├── unit/                  # Юніт-тести
│   │   ├── order.service.test.js
│   │   └── product.service.test.js
│   └── setup.js               # Налаштування тестового середовища
│
├── generated/                 # Згенерований Prisma клієнт
├── coverage/                  # Звіти про покриття коду тестами
└── package.json              # Залежності та скрипти
```

### Пояснення структури директорій

- **`src/routes/`** - Визначає HTTP маршрути та обробники запитів. Кожен файл відповідає за конкретну сутність (користувачі, замовлення, тощо). Відповідає за обробку HTTP-запитів, валідацію вхідних даних через JSON Schema та формування HTTP-відповідей.

- **`src/services/`** - Містить бізнес-логіку та взаємодію з базою даних через Prisma. Відокремлює логіку від HTTP-шару. Містить обробку транзакцій та складну логіку (наприклад, оновлення статусу замовлення з автоматичним управлінням складом).

- **`src/schemas/`** - JSON Schema для валідації вхідних даних запитів (тіло, параметри, query string). Забезпечує типобезпеку та запобігає помилкам.

- **`src/utils/`** - Допоміжні функції, зокрема обробка помилок та визначення HTTP статус-кодів. Централізована система обробки помилок з автоматичним визначенням відповідних HTTP статус-кодів.

- **`src/db/`** - Ініціалізація та конфігурація Prisma клієнта для роботи з базою даних.

- **`test/integration/`** - Інтеграційні тести, що перевіряють повний цикл запит-відповідь через HTTP API. Покривають всі 13 сутностей системи, перевіряють CRUD операції, фільтрацію та пошук, спеціальні endpoints.

- **`test/unit/`** - Юніт-тести для окремих функцій сервісів з використанням моків. Тестують складну бізнес-логіку з ізоляцією тестованої логіки.

## Архітектура проєкту

Проєкт організований за принципами чистої архітектури з розділенням відповідальності:

### Шар маршрутизації (`src/routes/`)
Відповідає за обробку HTTP-запитів, валідацію вхідних даних через JSON Schema та формування HTTP-відповідей.

### Шар сервісів (`src/services/`)
Містить бізнес-логіку, взаємодію з базою даних через Prisma ORM, обробку транзакцій та складну логіку (наприклад, оновлення статусу замовлення з автоматичним управлінням складом).

### Шар даних (`src/db/`)
Ініціалізація та конфігурація Prisma клієнта для роботи з базою даних.

### Валідація (`src/schemas/`)
JSON Schema файли для валідації всіх вхідних даних API.

## База даних

База даних містить 13 основних таблиць:

1. **User** - користувачі системи
2. **address** - адреси доставки
3. **PostalRegion** - поштові регіони
4. **product** - товари
5. **category** - категорії товарів (з підтримкою ієрархії)
6. **cart** - кошики покупок
7. **cartitem** - елементи кошика
8. **Order** - замовлення
9. **delivery** - доставки
10. **payment** - платежі
11. **review** - відгуки на продукти
12. **wishlist** - список бажань
13. **DiscountRule** - правила знижок

База даних оптимізована за допомогою індексів для часто використовуваних запитів (фільтрація за статусом, датою створення, користувачем тощо).

## Тестування

Проєкт включає комплексне тестування:

### Інтеграційні тести (`test/integration/`)
Покривають всі 13 сутностей системи. Кожен тест:
- Очищає базу даних перед виконанням
- Перевіряє CRUD операції (створення, читання, оновлення, видалення)
- Тестує фільтрацію та пошук
- Перевіряє спеціальні endpoints (наприклад, створення замовлення з продуктами, оновлення статусу замовлення)

### Юніт-тести (`test/unit/`)
Тестують складну бізнес-логіку:
- `order.service.test.js` - тестує `updateOrderStatusWithReconciliation` (автоматичне управління складом при зміні статусу замовлення)
- `product.service.test.js` - тестує `getMostSuccessfulProducts` (отримання найпопулярніших продуктів)

Юніт-тести використовують моки Prisma клієнта для ізоляції тестованої логіки.

### Покриття тестами

Проєкт має високе покриття тестами (приблизно 70%+), включаючи:
- Всі CRUD операції для кожної сутності
- Фільтрацію та пошук
- Складну бізнес-логіку
- Обробку помилок та крайових випадків

## Ключові особливості реалізації

### Транзакційність операцій
Критичні операції (створення замовлення, оновлення статусу) виконуються в транзакціях для забезпечення цілісності даних.

### Валідація даних
Всі вхідні дані валідуються через JSON Schema перед обробкою, що забезпечує типобезпеку та запобігає помилкам.

### Обробка помилок
Централізована система обробки помилок з автоматичним визначенням відповідних HTTP статус-кодів.

## Docker та контейнеризація

Проєкт повністю контейнеризований:
- **postgres** - основна база даних (порт 5434)
- **postgres-test** - тестова база даних (порт 5435)
- **app** - додаток (порт 3000)

Docker Compose автоматично налаштовує мережу між сервісами та забезпечує правильну послідовність запуску.

## Приклади використання API

### Користувачі

#### Створення користувача
```bash
POST /users
Content-Type: application/json

{
  "first_name": "Ivan",
  "last_name": "Petrenko",
  "email": "ivan@example.com",
  "password_hash": "g323n&#&#*#lsJSN",
  "phone": "+380501234567",
  "role": "customer"
}
```

#### Отримання користувача за ID
```bash
GET /users/1
```

#### Отримання всіх користувачів з фільтрами
```bash
GET /users?role=customer&is_active=true
```

#### Оновлення користувача
```bash
PUT /users/1
Content-Type: application/json

{
  "first_name": "Ivan",
  "last_name": "Petrenko",
  "phone": "+380509876543"
}
```

#### Видалення користувача
```bash
DELETE /users/1
```

### Продукти

#### Створення продукту
```bash
POST /products
Content-Type: application/json

{
  "name": "Laptop",
  "description": "Powerfull laptop for gaming",
  "price": 25000.00,
  "stock": 10,
  "category_id": 1,
  "status": "active"
}
```

#### Отримання продуктів з фільтрами
```bash
GET /products?category_id=1&status=active
```

#### Отримання найуспішніших продуктів
```bash
GET /products/most-successful?limit=10
```

### Замовлення

#### Створення замовлення
```bash
POST /orders
Content-Type: application/json

{
  "user_id": 1,
  "address_id": 1,
  "cart_id": 1,
  "total_amount": 5000.00,
  "applied_discount_id": 1
}
```

#### Створення замовлення з продуктами
```bash
POST /orders/with-products
Content-Type: application/json

{
  "user_id": 1,
  "address_id": 1,
  "products": [
    {
      "product_id": 1,
      "quantity": 2
    },
    {
      "product_id": 2,
      "quantity": 1
    }
  ],
  "total_amount": 7500.00,
  "applied_discount_id": null
}
```

#### Оновлення статусу замовлення
```bash
PATCH /orders/1/status
Content-Type: application/json

{
  "status": "paid"
}
```

#### Отримання замовлень користувача
```bash
GET /orders/with-user?user_id=1
```

### Кошик

#### Створення кошика
```bash
POST /carts
Content-Type: application/json

{
  "user_id": 1
}
```

#### Додавання товару до кошика
```bash
POST /cart-items
Content-Type: application/json

{
  "cart_id": 1,
  "product_id": 1,
  "quantity": 2
}
```

### Адреси

#### Створення адреси
```bash
POST /addresses
Content-Type: application/json

{
  "user_id": 1,
  "street": "Polytechnic str.",
  "postal_code": "01001",
  "is_default": true
}
```

### Категорії

#### Створення категорії
```bash
POST /categories
Content-Type: application/json

{
  "name": "Electronics",
  "description": "Electronic devices",
  "parent_id": null
}
```

### Доставка

#### Створення доставки
```bash
POST /deliveries
Content-Type: application/json

{
  "order_id": 1,
  "courier": "Nova Poshta",
  "tracking_number": "NP123456789",
  "status": "preparing"
}
```

### Оплата

#### Створення платежу
```bash
POST /payments
Content-Type: application/json

{
  "order_id": 1,
  "method": "card",
  "amount": 5000.00,
  "status": "pending"
}
```

### Відгуки

#### Створення відгуку
```bash
POST /reviews
Content-Type: application/json

{
  "user_id": 1,
  "product_id": 1,
  "rating": 5,
  "comment": "Nice!"
}
```

### Список бажань

#### Додавання до списку бажань
```bash
POST /wishlist
Content-Type: application/json

{
  "user_id": 1,
  "product_id": 1
}
```

### Правила знижок

#### Створення правила знижки
```bash
POST /discount-rules
Content-Type: application/json

{
  "code": "SUMMER2025",
  "type": "percent",
  "value": 15.00,
  "valid_from": "2025-06-01T00:00:00Z",
  "valid_to": "2025-08-31T23:59:59Z",
  "is_active": true
}
```

### Поштові регіони

#### Створення поштового регіону
```bash
POST /postal-regions
Content-Type: application/json

{
  "postal_code": "01001",
  "city": "Київ",
  "country": "Україна"
}
```

## Статус-коди відповідей

- `200` - Успішний запит
- `201` - Ресурс успішно створено
- `400` - Неправильний запит
- `404` - Ресурс не знайдено
- `409` - Конфлікт (наприклад, унікальне обмеження)
- `500` - Внутрішня помилка сервера

## Висновки

Проєкт успішно реалізує повнофункціональну систему управління електронною комерцією з:
- Чистою архітектурою та розділенням відповідальності
- Комплексним тестуванням
- Оптимізованою базою даних
- Готовністю до продакшн використання через Docker
- Детальною документацією

Система готова до використання та може бути легко розширена додатковими функціями.
